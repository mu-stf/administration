<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุฅุญุตุงุฆูุงุช - ูุธุงู ุงูุฅุฏุงุฑุฉ ุงููุชูุงูู</title>
    <link rel="stylesheet" href="css/style-responsive.css">
</head>

<body>
    <div id="loadingOverlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 20px;">๐</div>
            <div style="font-size: 18px; color: #666;">ุฌุงุฑู ุงูุชุญููู...</div>
        </div>
    </div>

    <header class="header">
        <h1>ุฃููุงู <span id="storeName">ูุธุงู ุงูุฅุฏุงุฑุฉ ุงููุชูุงูู</span></h1>
        <div class="header-actions">
            <button class="btn" onclick="logout()">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
        </div>
    </header>

    <div class="main-layout">
        <nav class="sidebar">
            <ul class="nav-menu">
                <li class="nav-item"><a href="dashboard.html" class="nav-link"><span class="icon">๐</span>ููุญุฉ ุงูุชุญูู</a></li>
                <li class="nav-item"><a href="new-invoice.html" class="nav-link"><span class="icon">โ</span>ูุงุชูุฑุฉ ุฌุฏูุฏุฉ</a></li>
                <li class="nav-item"><a href="invoices.html" class="nav-link"><span class="icon">๐</span>ุงูููุงุชูุฑ</a></li>
                <li class="nav-item"><a href="products.html" class="nav-link"><span class="icon">๐ฆ</span>ุงูููุชุฌุงุช</a></li>
                <li class="nav-item"><a href="customers.html" class="nav-link"><span class="icon">๐ฅ</span>ุงูุฒุจุงุฆู</a></li>
                <li class="nav-item"><a href="supplies.html" class="nav-link"><span class="icon">๐</span>ุงูุชูุฑูุฏุงุช</a></li>
                <li class="nav-item"><a href="statistics.html" class="nav-link active"><span class="icon">๐</span>ุงูุฅุญุตุงุฆูุงุช</a></li>
                <li class="nav-item"><a href="settings.html" class="nav-link"><span class="icon">โ๏ธ</span>ุงูุฅุนุฏุงุฏุงุช</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <!-- ููุชุฑ ุงูุชุงุฑูุฎ -->
            <div class="card mb-3">
                <div class="card-body">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <label><strong>ุงููุชุฑุฉ ุงูุฒูููุฉ:</strong></label>
                        <select id="periodFilter" class="form-control" style="max-width: 200px;" onchange="loadStats()">
                            <option value="today">ุงูููู</option>
                            <option value="week">ูุฐุง ุงูุฃุณุจูุน</option>
                            <option value="month" selected>ูุฐุง ุงูุดูุฑ</option>
                            <option value="year">ูุฐู ุงูุณูุฉ</option>
                            <option value="custom">ูุชุฑุฉ ูุฎุตุตุฉ</option>
                        </select>
                        <div id="customDates" style="display: none; gap: 10px;">
                            <input type="date" id="dateFrom" class="form-control">
                            <input type="date" id="dateTo" class="form-control">
                            <button class="btn btn-primary" onclick="loadStats()">๐ ุจุญุซ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุฅุญุตุงุฆูุงุช ุนุงูุฉ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue">๐</div>
                    <div class="stat-info">
                        <h3 id="totalInvoices">0</h3>
                        <p>ุฅุฌูุงูู ุงูููุงุชูุฑ</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">๐ฐ</div>
                    <div class="stat-info">
                        <h3 id="totalSales">0 ุฏ.ุน</h3>
                        <p>ุฅุฌูุงูู ุงููุจูุนุงุช</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">๐</div>
                    <div class="stat-info">
                        <h3 id="totalProfit">0 ุฏ.ุน</h3>
                        <p>ุฅุฌูุงูู ุงูุฃุฑุจุงุญ</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">๐</div>
                    <div class="stat-info">
                        <h3 id="avgInvoice">0 ุฏ.ุน</h3>
                        <p>ูุชูุณุท ุงููุงุชูุฑุฉ</p>
                    </div>
                </div>
            </div>

            <!-- ุงูููุชุฌุงุช ุงูุฃูุซุฑ ูุจูุนุงู -->
            <div class="card mb-3">
                <div class="card-header">
                    <h2>๐ ุงูููุชุฌุงุช ุงูุฃูุซุฑ ูุจูุนุงู</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>ุงูููุชุฌ</th>
                                    <th>ุงููููุฉ ุงููุจุงุนุฉ</th>
                                    <th>ุฅุฌูุงูู ุงููุจูุนุงุช</th>
                                </tr>
                            </thead>
                            <tbody id="topProducts">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">ูุง ุชูุฌุฏ ุจูุงูุงุช</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ููุฎุต ุงููุจูุนุงุช ูุงููุดุชุฑูุงุช -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="card">
                    <div class="card-header">
                        <h2>๐ต ููุฎุต ุงูููุฏ ูุงูุขุฌู</h2>
                    </div>
                    <div class="card-body">
                        <div style="margin-bottom: 15px;">
                            <strong>ูุจูุนุงุช ููุฏูุฉ:</strong>
                            <span id="cashSales" style="float: left;">0 ุฏ.ุน</span>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>ูุจูุนุงุช ุขุฌูุฉ:</strong>
                            <span id="creditSales" style="float: left;">0 ุฏ.ุน</span>
                        </div>
                        <hr>
                        <div>
                            <strong>ุงูุฏููู ุงููุณุชุญูุฉ:</strong>
                            <span id="totalDebt" style="float: left; color: #dc2626;">0 ุฏ.ุน</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>๐ฆ ููุฎุต ุงููุฎุฒูู</h2>
                    </div>
                    <div class="card-body">
                        <div style="margin-bottom: 15px;">
                            <strong>ุนุฏุฏ ุงูููุชุฌุงุช:</strong>
                            <span id="totalProducts" style="float: left;">0</span>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>ูููุฉ ุงููุฎุฒูู:</strong>
                            <span id="stockValue" style="float: left;">0 ุฏ.ุน</span>
                        </div>
                        <div>
                            <strong>ููุชุฌุงุช ููููุฉ ุงููุฎุฒูู:</strong>
                            <span id="lowStockCount" style="float: left; color: #dc2626;">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/page-protection.js"></script>
    <script src="js/utils.js"></script>
    <script>
        let currentUser = null;

        protectPage().then(authorized => { if (authorized) loadPage(); });

        async function loadPage() {
            const { user, profile } = await getCurrentUserData();
            currentUser = user;
            document.getElementById('storeName').textContent = profile.store_name;

            // ุฅุนุฏุงุฏ ููุชุฑ ุงูุชุงุฑูุฎ ุงููุฎุตุต
            document.getElementById('periodFilter').addEventListener('change', function() {
                const customDates = document.getElementById('customDates');
                customDates.style.display = this.value === 'custom' ? 'flex' : 'none';
                if (this.value !== 'custom') loadStats();
            });

            await loadStats();
            hideLoading();
        }

        function getDateRange() {
            const period = document.getElementById('periodFilter').value;
            const now = new Date();
            let from, to;

            switch (period) {
                case 'today':
                    from = Utils.getStartOfDay(now);
                    to = Utils.getEndOfDay(now);
                    break;
                case 'week':
                    from = new Date(now);
                    from.setDate(now.getDate() - 7);
                    to = Utils.getEndOfDay(now);
                    break;
                case 'month':
                    from = new Date(now.getFullYear(), now.getMonth(), 1);
                    to = Utils.getEndOfDay(now);
                    break;
                case 'year':
                    from = new Date(now.getFullYear(), 0, 1);
                    to = Utils.getEndOfDay(now);
                    break;
                case 'custom':
                    from = new Date(document.getElementById('dateFrom').value);
                    to = new Date(document.getElementById('dateTo').value + 'T23:59:59');
                    break;
            }

            return { from, to };
        }

        async function loadStats() {
            try {
                const { from, to } = getDateRange();

                // ุฅุญุตุงุฆูุงุช ุงูููุงุชูุฑ
                const stats = await SupabaseDB.getStatistics(currentUser.id, from, to);
                
                document.getElementById('totalInvoices').textContent = stats.invoiceCount;
                document.getElementById('totalSales').textContent = Utils.formatCurrency(stats.totalSales);
                document.getElementById('totalProfit').textContent = Utils.formatCurrency(stats.profit);
                document.getElementById('avgInvoice').textContent = stats.invoiceCount > 0 
                    ? Utils.formatCurrency(stats.totalSales / stats.invoiceCount) 
                    : '0 ุฏ.ุน';

                // ุงูููุฏ ูุงูุขุฌู
                const invoices = await SupabaseDB.getInvoices(currentUser.id);
                const filteredInvoices = invoices.filter(inv => {
                    const invDate = new Date(inv.date);
                    return invDate >= from && invDate <= to && inv.status === 'active';
                });

                const cashSales = filteredInvoices
                    .filter(inv => inv.payment_type === 'cash')
                    .reduce((sum, inv) => sum + inv.final_total, 0);
                const creditSales = filteredInvoices
                    .filter(inv => inv.payment_type === 'credit')
                    .reduce((sum, inv) => sum + inv.final_total, 0);
                const totalDebt = filteredInvoices
                    .filter(inv => inv.payment_type === 'credit')
                    .reduce((sum, inv) => sum + (inv.remaining_amount || 0), 0);

                document.getElementById('cashSales').textContent = Utils.formatCurrency(cashSales);
                document.getElementById('creditSales').textContent = Utils.formatCurrency(creditSales);
                document.getElementById('totalDebt').textContent = Utils.formatCurrency(totalDebt);

                // ุฅุญุตุงุฆูุงุช ุงููุฎุฒูู
                const products = await SupabaseDB.getProducts(currentUser.id);
                const stockValue = products.reduce((sum, p) => sum + (p.purchase_price * p.stock), 0);
                const lowStockCount = products.filter(p => p.stock <= p.min_stock).length;

                document.getElementById('totalProducts').textContent = products.length;
                document.getElementById('stockValue').textContent = Utils.formatCurrency(stockValue);
                document.getElementById('lowStockCount').textContent = lowStockCount;

                // ุงูููุชุฌุงุช ุงูุฃูุซุฑ ูุจูุนุงู
                await loadTopProducts(filteredInvoices);

            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุงูุฅุญุตุงุฆูุงุช:', error);
            }
        }

        async function loadTopProducts(invoices) {
            try {
                // ุฌูุน ูู ุนูุงุตุฑ ุงูููุงุชูุฑ
                const productSales = {};
                
                for (const inv of invoices) {
                    const items = await SupabaseDB.getInvoiceItems(inv.id);
                    for (const item of items) {
                        if (!productSales[item.product_name]) {
                            productSales[item.product_name] = { quantity: 0, total: 0 };
                        }
                        productSales[item.product_name].quantity += item.quantity;
                        productSales[item.product_name].total += item.total;
                    }
                }

                // ุชุฑุชูุจ ุญุณุจ ุงููููุฉ
                const sorted = Object.entries(productSales)
                    .sort((a, b) => b[1].quantity - a[1].quantity)
                    .slice(0, 10);

                const tbody = document.getElementById('topProducts');
                if (sorted.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>';
                    return;
                }

                tbody.innerHTML = sorted.map((item, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item[0]}</td>
                        <td>${item[1].quantity}</td>
                        <td>${Utils.formatCurrency(item[1].total)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading top products:', error);
            }
        }
    </script>
</body>

</html>