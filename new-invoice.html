<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุงุชูุฑุฉ ุฌุฏูุฏุฉ - ูุธุงู ุฅุฏุงุฑุฉ ุงููุญู</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <h1>๐ช <span id="storeName">ูุธุงู ุฅุฏุงุฑุฉ ุงููุญู</span></h1>
        <div class="header-actions">
            <button class="btn" onclick="App.logout()">
                ๐ช ุชุณุฌูู ุงูุฎุฑูุฌ
            </button>
        </div>
    </header>

    <div class="main-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <span class="icon">๐</span>
                        ููุญุฉ ุงูุชุญูู
                    </a>
                </li>
                <li class="nav-item">
                    <a href="new-invoice.html" class="nav-link active">
                        <span class="icon">โ</span>
                        ูุงุชูุฑุฉ ุฌุฏูุฏุฉ
                    </a>
                </li>
                <li class="nav-item">
                    <a href="invoices.html" class="nav-link">
                        <span class="icon">๐</span>
                        ุงูููุงุชูุฑ
                    </a>
                </li>
                <li class="nav-item">
                    <a href="products.html" class="nav-link">
                        <span class="icon">๐ฆ</span>
                        ุงูููุชุฌุงุช
                    </a>
                </li>
                <li class="nav-item">
                    <a href="customers.html" class="nav-link">
                        <span class="icon">๐ฅ</span>
                        ุงูุฒุจุงุฆู
                    </a>
                </li>
                <li class="nav-item">
                    <a href="supplies.html" class="nav-link">
                        <span class="icon">๐ฅ</span>
                        ุงูุชูุฑูุฏุงุช
                    </a>
                </li>
                <li class="nav-item">
                    <a href="statistics.html" class="nav-link">
                        <span class="icon">๐</span>
                        ุงูุฅุญุตุงุฆูุงุช
                    </a>
                </li>
                <li class="nav-item">
                    <a href="settings.html" class="nav-link">
                        <span class="icon">โ๏ธ</span>
                        ุงูุฅุนุฏุงุฏุงุช
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="card">
                <div class="card-header">
                    <h2>โ ูุงุชูุฑุฉ ุฌุฏูุฏุฉ</h2>
                    <span id="invoiceNumber" class="badge badge-info" style="font-size: 16px;"></span>
                </div>
                <div class="card-body">
                    <!-- Customer Selection -->
                    <div class="form-group" style="max-width: 400px;">
                        <label for="customerSelect">ุงูุฒุจูู (ุงุฎุชูุงุฑู)</label>
                        <select id="customerSelect" class="form-control">
                            <option value="">-- ุจุฏูู ุฒุจูู --</option>
                        </select>
                    </div>

                    <!-- Add Product -->
                    <div class="quick-add">
                        <div class="form-group flex-1">
                            <label for="productSelect">ุงูููุชุฌ</label>
                            <select id="productSelect" class="form-control">
                                <option value="">-- ุงุฎุชุฑ ููุชุฌ --</option>
                            </select>
                        </div>
                        <div class="form-group" style="width: 120px;">
                            <label for="quantity">ุงููููุฉ</label>
                            <input type="number" id="quantity" class="form-control" value="1" min="1">
                        </div>
                        <button class="btn btn-primary" onclick="addItem()" style="margin-bottom: 0;">
                            โ ุฅุถุงูุฉ
                        </button>
                    </div>

                    <!-- Invoice Items -->
                    <div class="invoice-items" id="invoiceItems">
                        <div class="empty-state" id="emptyState">
                            <div class="icon">๐</div>
                            <h3>ูุง ุชูุฌุฏ ููุชุฌุงุช</h3>
                            <p>ูู ุจุฅุถุงูุฉ ููุชุฌุงุช ูููุงุชูุฑุฉ</p>
                        </div>
                    </div>

                    <!-- Invoice Summary -->
                    <div class="invoice-summary" id="invoiceSummary" style="display: none;">
                        <div class="row">
                            <span>ุนุฏุฏ ุงูููุชุฌุงุช:</span>
                            <span id="itemCount">0</span>
                        </div>
                        <div class="row total-row">
                            <span>ุงูุฅุฌูุงูู:</span>
                            <span id="totalAmount">0 ุฏ.ุน</span>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group mt-3">
                        <label for="notes">ููุงุญุธุงุช (ุงุฎุชูุงุฑู)</label>
                        <textarea id="notes" class="form-control" rows="2"
                            placeholder="ุฃู ููุงุญุธุงุช ุฅุถุงููุฉ..."></textarea>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-success" onclick="saveInvoice()" id="saveBtn" disabled>
                            ๐พ ุญูุธ ุงููุงุชูุฑุฉ
                        </button>
                        <button class="btn btn-secondary" onclick="clearInvoice()">
                            ๐๏ธ ูุณุญ ุงููู
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/app.js"></script>
    <script>
        // ุญูุงูุฉ ุงูุตูุญุฉ
        if (!App.protectPage()) {
            throw new Error('Unauthorized');
        }

        // ุงููุชุบูุฑุงุช ุงูุนุงูุฉ
        let invoiceItems = [];
        let products = [];

        // ุชุญููู ุงูุจูุงูุงุช
        function loadData() {
            const settings = App.getSettings();
            document.getElementById('storeName').textContent = settings.storeName;
            document.getElementById('invoiceNumber').textContent = App.getNextInvoiceNumber();

            // ุชุญููู ุงูุฒุจุงุฆู
            const customers = App.getCustomers();
            const customerSelect = document.getElementById('customerSelect');
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name + (c.phone ? ` (${c.phone})` : '');
                customerSelect.appendChild(option);
            });

            // ุชุญููู ุงูููุชุฌุงุช
            products = App.getProducts().filter(p => p.stock > 0);
            const productSelect = document.getElementById('productSelect');
            products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} - ${Utils.formatCurrency(p.salePrice)} (ูุชููุฑ: ${p.stock})`;
                productSelect.appendChild(option);
            });
        }

        // ุฅุถุงูุฉ ููุชุฌ ูููุงุชูุฑุฉ
        function addItem() {
            const productId = document.getElementById('productSelect').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;

            if (!productId) {
                Utils.showAlert('ูุฑุฌู ุงุฎุชูุงุฑ ููุชุฌ', 'warning');
                return;
            }

            const product = products.find(p => p.id === productId);
            if (!product) return;

            // ุงูุชุญูู ูู ุงููููุฉ ุงููุชุงุญุฉ
            const existingItem = invoiceItems.find(i => i.productId === productId);
            const totalQuantity = (existingItem ? existingItem.quantity : 0) + quantity;

            if (totalQuantity > product.stock) {
                Utils.showAlert(`ุงููููุฉ ุงููุทููุจุฉ ุฃูุซุฑ ูู ุงููุชููุฑ (${product.stock})`, 'danger');
                return;
            }

            if (existingItem) {
                existingItem.quantity = totalQuantity;
            } else {
                invoiceItems.push({
                    productId: product.id,
                    productName: product.name,
                    quantity: quantity,
                    salePrice: product.salePrice,
                    purchasePrice: product.purchasePrice
                });
            }

            // ุฅุนุงุฏุฉ ุชุนููู ุงูุฅุฏุฎุงู
            document.getElementById('productSelect').value = '';
            document.getElementById('quantity').value = 1;

            renderItems();
        }

        // ุนุฑุถ ุงูููุชุฌุงุช
        function renderItems() {
            const container = document.getElementById('invoiceItems');
            const emptyState = document.getElementById('emptyState');
            const summary = document.getElementById('invoiceSummary');
            const saveBtn = document.getElementById('saveBtn');

            if (invoiceItems.length === 0) {
                container.innerHTML = '';
                container.appendChild(emptyState);
                emptyState.style.display = 'block';
                summary.style.display = 'none';
                saveBtn.disabled = true;
                return;
            }

            emptyState.style.display = 'none';
            saveBtn.disabled = false;
            summary.style.display = 'block';

            container.innerHTML = invoiceItems.map((item, index) => `
                <div class="invoice-item">
                    <span class="product-name">${item.productName}</span>
                    <div class="quantity-control">
                        <button onclick="updateQuantity(${index}, -1)">โ</button>
                        <span>${item.quantity}</span>
                        <button onclick="updateQuantity(${index}, 1)">+</button>
                    </div>
                    <span class="item-total">${Utils.formatCurrency(item.salePrice * item.quantity)}</span>
                    <span class="remove-btn" onclick="removeItem(${index})">๐๏ธ</span>
                </div>
            `).join('');

            // ุญุณุงุจ ุงูุฅุฌูุงูู
            const total = invoiceItems.reduce((sum, item) => sum + (item.salePrice * item.quantity), 0);
            document.getElementById('itemCount').textContent = invoiceItems.length;
            document.getElementById('totalAmount').textContent = Utils.formatCurrency(total);
        }

        // ุชุญุฏูุซ ุงููููุฉ
        function updateQuantity(index, change) {
            const item = invoiceItems[index];
            const product = products.find(p => p.id === item.productId);
            const newQuantity = item.quantity + change;

            if (newQuantity < 1) {
                removeItem(index);
                return;
            }

            if (newQuantity > product.stock) {
                Utils.showAlert(`ุงูุญุฏ ุงูุฃูุตู ุงููุชููุฑ: ${product.stock}`, 'warning');
                return;
            }

            item.quantity = newQuantity;
            renderItems();
        }

        // ุญุฐู ููุชุฌ
        function removeItem(index) {
            invoiceItems.splice(index, 1);
            renderItems();
        }

        // ูุณุญ ุงููู
        function clearInvoice() {
            invoiceItems = [];
            document.getElementById('customerSelect').value = '';
            document.getElementById('notes').value = '';
            renderItems();
        }

        // ุญูุธ ุงููุงุชูุฑุฉ
        async function saveInvoice() {
            if (invoiceItems.length === 0) {
                Utils.showAlert('ูุฑุฌู ุฅุถุงูุฉ ููุชุฌุงุช ูููุงุชูุฑุฉ', 'warning');
                return;
            }

            const customerSelect = document.getElementById('customerSelect');
            const customer = customerSelect.value ?
                App.getCustomerById(customerSelect.value) : null;

            const total = invoiceItems.reduce((sum, item) =>
                sum + (item.salePrice * item.quantity), 0
            );

            const invoiceData = {
                customerId: customer ? customer.id : null,
                customerName: customer ? customer.name : null,
                items: invoiceItems.map(item => ({ ...item })),
                total: total,
                notes: document.getElementById('notes').value.trim()
            };

            const invoice = App.createInvoice(invoiceData);

            Utils.showAlert('ุชู ุญูุธ ุงููุงุชูุฑุฉ ุจูุฌุงุญ!', 'success');

            // ุฅุนุงุฏุฉ ุชุนููู ุงูุตูุญุฉ
            setTimeout(() => {
                window.location.href = `print-invoice.html?id=${invoice.id}`;
            }, 1000);
        }

        // ุชุญููู ุงูุตูุญุฉ
        loadData();
        renderItems();
    </script>
</body>

</html>