<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>????? ???? - ???? ????? ?????</title>
    <link rel="stylesheet" href="css/style-responsive.css">
</head>

<body>
    <div class="auth-container">
        <div class="auth-box">
            <div class="icon">??</div>
            <h1>????? ???? ????</h1>
            <p>???? ????? ????? ?? ????? ????</p>

            <form id="registerForm">
                <div class="form-group">
                    <label for="email">?????? ??????????</label>
                    <input type="email" id="email" class="form-control" placeholder="example@email.com" required>
                </div>

                <div class="form-group">
                    <label for="password">???? ??????</label>
                    <input type="password" id="password" class="form-control" placeholder="8 ???? ??? ?????" required
                        minlength="8">
                    <small class="text-muted">??? ?? ???? 8 ???? ??? ?????</small>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">????? ???? ??????</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="??? ????? ???? ??????"
                        required>
                </div>

                <div id="errorMessage" class="alert alert-danger hidden"></div>
                <div id="successMessage" class="alert alert-success hidden"></div>

                <button type="submit" class="btn btn-primary btn-block" id="submitBtn">
                    ????? ??????
                </button>

                <div style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 15px;">
                    <button type="button" class="btn btn-block" style="background: #f0f0f0; color: #333;"
                        onclick="signInAsGuest()" id="guestBtn">
                        ?? ????? ?????? (???? ??????)
                    </button>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <p>???? ???? ??????? <a href="index.html">????? ??????</a></p>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/utils.js"></script>

    <script>
        // ????? ??? ????? ??? ??????? ?? ????? ???????? ????? ????? ???? ????
        localStorage.removeItem('is_guest');

        async function signInAsGuest() {
            const guestBtn = document.getElementById("guestBtn");
            const errorDiv = document.getElementById("errorMessage");
            const guestEmail = "guest@demo.com";
            const guestPass = "guest123456";

            try {
                guestBtn.disabled = true;
                guestBtn.textContent = "???? ????? ?????? ????????...";
                errorDiv.classList.add("hidden");

                localStorage.setItem("is_guest", "true");

                // ?????? ????? ??????
                try {
                    await SupabaseDB.signIn(guestEmail, guestPass);
                } catch (loginError) {
                    // ??? ??? ?????? ??? ?????? ???? ??????? ????????
                    if (loginError.message.includes("Invalid login credentials") || loginError.status === 400) {
                        guestBtn.textContent = "???? ????? ???? ?????? ????...";
                        await SupabaseDB.signUp(guestEmail, guestPass);
                        
                        // ?????? ????? ?????? ??? ???? ??? ???????
                        await SupabaseDB.signIn(guestEmail, guestPass);
                        
                        // ????? ??? ??????? ????? ??? ??? ?????
                        const user = await SupabaseDB.getCurrentUser();
                        await SupabaseDB.updateProfile(user.id, {
                            store_name: "??? ??????? (???? ?????)",
                            phone: "07700000000",
                            address: "????? - ???? ???????",
                            agent_name: "???? ?????",
                            invoice_prefix: "DEMO"
                        });
                    } else {
                        throw loginError;
                    }
                }

                window.location.href = "dashboard.html";
            } catch (error) {
                console.error("??? ?? ???? ?????:", error);
                errorDiv.textContent = "?????? ??? ?????? ????????: " + error.message;
                errorDiv.classList.remove("hidden");
                guestBtn.disabled = false;
                guestBtn.textContent = "?? ????? ?????? (???? ??????)";
                localStorage.removeItem("is_guest");
            }
        }
        // ?????? ?? ???? Supabase config
        if (typeof SUPABASE_CONFIG === 'undefined') {
            document.getElementById('errorMessage').textContent = '???: ?? ??? ?????? ??? ??? ???????. ?????? ????? js/config.js';
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('submitBtn').disabled = true;
        }

        // ??????: ?? ????? ?????? ???????? ?? ?????? ????? redirect loops
        // ???? ???????? ??????? ??? ?? ??? ???? ???? ????

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            const submitBtn = document.getElementById('submitBtn');

            // ????? ???????
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            // ?????? ?? ????? ???? ??????
            if (password !== confirmPassword) {
                errorDiv.textContent = '????? ?????? ??? ?????????';
                errorDiv.classList.remove('hidden');
                return;
            }

            // ?????? ?? ??? ???? ??????
            if (password.length < 8) {
                errorDiv.textContent = '???? ?????? ??? ?? ???? 8 ???? ??? ?????';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '???? ????? ??????...';

                // ??????? ??? Supabase
                const { user, session } = await SupabaseDB.signUp(email, password);

                successDiv.textContent = '?? ????? ?????? ?????! ???? ?????? ?????? ??????...';
                successDiv.classList.remove('hidden');

                // ???????? ????? ????? ??????
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);

            } catch (error) {
                console.error('??? ?? ???????:', error);

                let errorMessage = '??? ??? ????? ????? ??????';

                if (error.message.includes('already registered')) {
                    errorMessage = '??? ?????? ?????????? ???? ??????';
                } else if (error.message.includes('Invalid email')) {
                    errorMessage = '?????? ?????????? ??? ????';
                } else if (error.message.includes('Password')) {
                    errorMessage = '???? ?????? ????? ????';
                } else {
                    errorMessage = error.message;
                }

                errorDiv.textContent = errorMessage;
                errorDiv.classList.remove('hidden');

                submitBtn.disabled = false;
                submitBtn.textContent = '????? ??????';
            }
        });
    </script>
</body>

</html>