<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <link rel="stylesheet" href="css/style-responsive.css">
</head>

<body>
    <div id="loadingOverlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 20px;">âœï¸</div>
            <div style="font-size: 18px; color: #666;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©...</div>
        </div>
    </div>

    <header class="header">
        <h1>Ø£Ù‡Ù„Ø§Ù‹ <span id="storeName">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</span></h1>
        <div class="header-actions">
            <button class="btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <div class="main-layout">
        <nav class="sidebar">
            <ul class="nav-menu">
                <li class="nav-item"><a href="dashboard.html" class="nav-link"><span class="icon">ğŸ“Š</span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
                <li class="nav-item"><a href="new-invoice.html" class="nav-link"><span class="icon">â•</span>ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</a></li>
                <li class="nav-item"><a href="invoices.html" class="nav-link"><span class="icon">ğŸ“‹</span>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</a></li>
                <li class="nav-item"><a href="products.html" class="nav-link"><span class="icon">ğŸ“¦</span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a></li>
                <li class="nav-item"><a href="customers.html" class="nav-link"><span class="icon">ğŸ‘¥</span>Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</a></li>
                <li class="nav-item"><a href="supplies.html" class="nav-link active"><span class="icon">ğŸšš</span>Ø§Ù„ØªÙˆØ±ÙŠØ¯Ø§Øª</a></li>
                <li class="nav-item"><a href="statistics.html" class="nav-link"><span class="icon">ğŸ“ˆ</span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</a></li>
                <li class="nav-item"><a href="settings.html" class="nav-link"><span class="icon">âš™ï¸</span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="card">
                <div class="card-header">
                    <h2>âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡: <span id="invoiceNumber">-</span></h2>
                    <a href="supplies.html" class="btn btn-secondary">â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
                </div>
                <div class="card-body">
                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                            <input type="date" id="invoiceDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                            <input type="text" id="supplierName" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯">
                        </div>
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                            <input type="text" id="supplierInvoice" class="form-control" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
                        </div>
                    </div>

                    <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ -->
                    <div class="card" style="background: #f8f9fa; margin-bottom: 20px; overflow: visible;">
                        <div class="card-body" style="overflow: visible;">
                            <h3 style="margin: 0 0 15px; font-size: 16px;">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„ÙØ§ØªÙˆØ±Ø©</h3>
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; align-items: end;">
                                <div class="form-group" style="margin:0; position: relative;">
                                    <label>Ø§Ù„Ù…Ù†ØªØ¬</label>
                                    <input type="text" id="productSearch" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯..." autocomplete="off" oninput="filterProducts()" onfocus="showDropdown()" onblur="setTimeout(hideDropdown, 300)">
                                    <input type="hidden" id="selectedProductId">
                                    <div id="productDropdown" style="display:none; position:absolute; top:100%; left:0; right:0; max-height:300px; overflow-y:auto; background:white; border:2px solid #667eea; border-radius:8px; box-shadow:0 8px 25px rgba(0,0,0,0.25); z-index:9999;"></div>
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label>
                                    <input type="number" id="purchasePrice" class="form-control" min="0">
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                    <input type="number" id="productQuantity" class="form-control" value="1" min="1">
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
                                    <input type="number" id="salePrice" class="form-control" min="0">
                                </div>
                                <button class="btn btn-primary" onclick="addProductToInvoice()">+ Ø¥Ø¶Ø§ÙØ©</button>
                            </div>
                        </div>
                    </div>

                    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
                    <div class="table-responsive" style="margin-bottom: 20px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                                    <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItems">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Ø§Ù„Ù…Ù„Ø®Øµ -->
                    <div style="max-width: 400px; margin-right: auto; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 2px solid #ddd; font-size: 18px;">
                            <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong>
                            <strong id="finalTotal" style="color: #2563eb;">0 Ø¯.Ø¹</strong>
                        </div>

                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="saveInvoice()" id="saveBtn" style="flex:1">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                            <button class="btn btn-secondary" onclick="window.location.href='supplies.html'">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/page-protection.js"></script>
    <script src="js/utils.js"></script>
    <script>
        let currentUser = null;
        let currentProfile = null;
        let products = [];
        let invoiceItems = [];
        let currentInvoice = null;
        let invoiceId = null;
        let originalItems = []; // Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£ØµÙ„ÙŠØ©

        protectPage().then(authorized => { if (authorized) loadPage(); });

        async function loadPage() {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† URL
            const urlParams = new URLSearchParams(window.location.search);
            invoiceId = urlParams.get('id');
            
            if (!invoiceId) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù„Ù„ÙØ§ØªÙˆØ±Ø©');
                window.location.href = 'supplies.html';
                return;
            }

            const { user, profile } = await getCurrentUserData();
            currentUser = user;
            currentProfile = profile;
            document.getElementById('storeName').textContent = profile.store_name;

            await loadProducts();
            await loadInvoice();
            
            hideLoading();
        }

        async function loadProducts() {
            products = await SupabaseDB.getProducts(currentUser.id);
        }

        async function loadInvoice() {
            try {
                // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                const { data: invoice, error } = await supabase
                    .from('purchase_invoices')
                    .select('*')
                    .eq('id', invoiceId)
                    .single();

                if (error) throw error;
                if (!invoice) {
                    alert('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    window.location.href = 'supplies.html';
                    return;
                }

                currentInvoice = invoice;
                
                // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                document.getElementById('invoiceNumber').textContent = invoice.invoice_number;
                document.getElementById('invoiceDate').value = invoice.date ? invoice.date.split('T')[0] : '';
                document.getElementById('supplierName').value = invoice.supplier_name || '';
                document.getElementById('supplierInvoice').value = invoice.supplier_invoice || '';

                // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                const { data: items, error: itemsError } = await supabase
                    .from('purchase_invoice_items')
                    .select('*')
                    .eq('invoice_id', invoiceId);

                if (itemsError) throw itemsError;

                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                invoiceItems = (items || []).map(item => ({
                    id: item.id,
                    product_id: item.product_id,
                    product_name: item.product_name,
                    purchase_price: item.purchase_price || 0,
                    sale_price: item.sale_price || 0,
                    quantity: item.quantity || 0,
                    total: (item.purchase_price || 0) * (item.quantity || 0)
                }));

                // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£ØµÙ„ÙŠØ©
                originalItems = JSON.parse(JSON.stringify(invoiceItems));

                renderInvoiceItems();

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + error.message);
            }
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ---
        function filterProducts() {
            const query = document.getElementById('productSearch').value.toLowerCase().trim();
            
            if (!query) {
                renderProductDropdown(products);
                return;
            }

            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(query) || 
                (p.barcode && p.barcode.toLowerCase().includes(query))
            );

            renderProductDropdown(filtered);
        }

        function renderProductDropdown(list) {
            const dropdown = document.getElementById('productDropdown');
            
            if (list.length === 0) {
                dropdown.innerHTML = '<div style="padding:12px; color:#666; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                dropdown.style.display = 'block';
                return;
            }

            dropdown.innerHTML = list.map(p => `
                <div onclick="selectProduct('${p.id}')" 
                     style="padding:10px 15px; cursor:pointer; border-bottom:1px solid #eee; transition:background 0.2s;"
                     onmouseover="this.style.background='#f0f7ff'" 
                     onmouseout="this.style.background='white'">
                    <div style="font-weight:600; color:#333;">${p.name}</div>
                    <div style="font-size:12px; color:#666; display:flex; justify-content:space-between; margin-top:3px;">
                        <span>Ø´Ø±Ø§Ø¡: ${(p.purchase_price || 0).toLocaleString()}</span>
                        <span>Ø¨ÙŠØ¹: ${(p.sale_price || 0).toLocaleString()}</span>
                    </div>
                </div>
            `).join('');
            dropdown.style.display = 'block';
        }

        function showDropdown() {
            renderProductDropdown(products);
        }

        function hideDropdown() {
            document.getElementById('productDropdown').style.display = 'none';
        }

        function selectProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                document.getElementById('productSearch').value = product.name;
                document.getElementById('selectedProductId').value = product.id;
                document.getElementById('purchasePrice').value = product.purchase_price || '';
                document.getElementById('salePrice').value = product.sale_price || '';
                hideDropdown();
                document.getElementById('productQuantity').focus();
            }
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ---
        function addProductToInvoice() {
            const productName = document.getElementById('productSearch').value.trim();
            const productId = document.getElementById('selectedProductId').value;
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const quantity = parseInt(document.getElementById('productQuantity').value) || 1;
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;

            if (!productName) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬');
                return;
            }

            invoiceItems.push({
                id: null, // Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯
                product_id: productId || null,
                product_name: productName,
                purchase_price: purchasePrice,
                sale_price: salePrice,
                quantity: quantity,
                total: purchasePrice * quantity
            });

            renderInvoiceItems();
            
            // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('productSearch').value = '';
            document.getElementById('selectedProductId').value = '';
            document.getElementById('purchasePrice').value = '';
            document.getElementById('productQuantity').value = '1';
            document.getElementById('salePrice').value = '';
        }

        function renderInvoiceItems() {
            const tbody = document.getElementById('invoiceItems');
            if (invoiceItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</td></tr>';
                calculateTotal();
                return;
            }

            tbody.innerHTML = invoiceItems.map((item, index) => `
                <tr>
                    <td>${item.product_name}</td>
                    <td>${item.purchase_price.toLocaleString()} Ø¯.Ø¹</td>
                    <td>
                        <input type="number" value="${item.quantity}" min="1" 
                               style="width:70px; padding:5px; border:1px solid #ddd; border-radius:4px;"
                               onchange="updateQuantity(${index}, this.value)">
                    </td>
                    <td>${item.sale_price.toLocaleString()} Ø¯.Ø¹</td>
                    <td>${item.total.toLocaleString()} Ø¯.Ø¹</td>
                    <td><button class="btn btn-sm btn-danger" onclick="removeItem(${index})">ğŸ—‘ï¸</button></td>
                </tr>
            `).join('');

            calculateTotal();
        }

        function updateQuantity(index, newQty) {
            const qty = parseInt(newQty) || 1;
            invoiceItems[index].quantity = qty;
            invoiceItems[index].total = invoiceItems[index].purchase_price * qty;
            renderInvoiceItems();
        }

        function removeItem(index) {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) {
                invoiceItems.splice(index, 1);
                renderInvoiceItems();
            }
        }

        function calculateTotal() {
            const total = invoiceItems.reduce((sum, item) => sum + item.total, 0);
            document.getElementById('finalTotal').textContent = total.toLocaleString() + ' Ø¯.Ø¹';
        }

        // --- Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ---
        async function saveInvoice() {
            if (invoiceItems.length === 0) {
                alert('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ÙØ§ØªÙˆØ±Ø©!');
                return;
            }

            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

            try {
                const total = invoiceItems.reduce((sum, item) => sum + item.total, 0);

                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                const { error: invoiceError } = await supabase
                    .from('purchase_invoices')
                    .update({
                        supplier_name: document.getElementById('supplierName').value.trim() || 'Ù…ÙˆØ±Ø¯',
                        supplier_invoice: document.getElementById('supplierInvoice').value.trim(),
                        total: total,
                        date: new Date(document.getElementById('invoiceDate').value).toISOString()
                    })
                    .eq('id', invoiceId);

                if (invoiceError) throw invoiceError;

                // Ø­Ø°Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                const { error: deleteError } = await supabase
                    .from('purchase_invoice_items')
                    .delete()
                    .eq('invoice_id', invoiceId);

                if (deleteError) throw deleteError;

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                const itemsToInsert = invoiceItems.map(item => ({
                    invoice_id: invoiceId,
                    product_id: item.product_id,
                    product_name: item.product_name,
                    purchase_price: item.purchase_price,
                    sale_price: item.sale_price,
                    quantity: item.quantity,
                    total: item.total,
                    user_id: currentUser.id
                }));

                const { error: insertError } = await supabase
                    .from('purchase_invoice_items')
                    .insert(itemsToInsert);

                if (insertError) throw insertError;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                for (const item of invoiceItems) {
                    if (item.product_id) {
                        const originalItem = originalItems.find(o => o.product_id === item.product_id);
                        const originalQty = originalItem ? originalItem.quantity : 0;
                        const qtyDiff = item.quantity - originalQty;

                        if (qtyDiff !== 0) {
                            const product = products.find(p => p.id === item.product_id);
                            if (product) {
                                await supabase
                                    .from('products')
                                    .update({ 
                                        stock: product.stock + qtyDiff,
                                        purchase_price: item.purchase_price,
                                        sale_price: item.sale_price
                                    })
                                    .eq('id', item.product_id);
                            }
                        }
                    }
                }

                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                window.location.href = 'supplies.html';

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
            }
        }
    </script>
</body>

</html>