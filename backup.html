<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุฃูุงู - ูุธุงู ุฅุฏุงุฑุฉ ุงููุญู</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div id="loadingOverlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 20px;">๐ช</div>
            <div style="font-size: 18px; color: #666;">ุฌุงุฑู ุงูุชุญููู...</div>
        </div>
    </div>

    <header class="header">
        <h1>๐ช <span id="storeName">ูุธุงู ุฅุฏุงุฑุฉ ุงููุญู</span></h1>
        <div class="header-actions"><button class="btn" onclick="logout()">๐ช ุชุณุฌูู ุงูุฎุฑูุฌ</button></div>
    </header>

    <div class="main-layout">
        <nav class="sidebar">
            <ul class="nav-menu">
                <li class="nav-item"><a href="dashboard.html" class="nav-link"><span class="icon">๐</span>ููุญุฉ ุงูุชุญูู</a></li>
                <li class="nav-item"><a href="new-invoice.html" class="nav-link"><span class="icon">โ</span>ูุงุชูุฑุฉ ุฌุฏูุฏุฉ</a></li>
                <li class="nav-item"><a href="invoices.html" class="nav-link"><span class="icon">๐</span>ุงูููุงุชูุฑ</a></li>
                <li class="nav-item"><a href="products.html" class="nav-link"><span class="icon">๐ฆ</span>ุงูููุชุฌุงุช</a></li>
                <li class="nav-item"><a href="customers.html" class="nav-link"><span class="icon">๐ฅ</span>ุงูุฒุจุงุฆู</a></li>
                <li class="nav-item"><a href="customer-accounts.html" class="nav-link"><span class="icon">๐ฐ</span>ุงูุญุณุงุจุงุช</a></li>
                <li class="nav-item"><a href="supplies.html" class="nav-link"><span class="icon">๐ฅ</span>ููุงุชูุฑ ุงูุดุฑุงุก</a></li>
                <li class="nav-item"><a href="statistics.html" class="nav-link"><span class="icon">๐</span>ุงูุฅุญุตุงุฆูุงุช</a></li>
                <li class="nav-item"><a href="backup.html" class="nav-link active"><span class="icon">๐</span>ุงููุณุฎ ูุงูุฃูุงู</a></li>
                <li class="nav-item"><a href="settings.html" class="nav-link"><span class="icon">โ๏ธ</span>ุงูุฅุนุฏุงุฏุงุช</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <!-- ุงููุณุฎ ุงูุงุญุชูุงุทู -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h2>๐พ ุงููุณุฎ ุงูุงุญุชูุงุทู</h2>
                </div>
                <div class="card-body">
                    <div style="display: grid; gap: 15px;">
                        <!-- ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ -->
                        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border: 2px solid #3b82f6;">
                            <h3 style="margin: 0 0 10px 0; color: #1e40af;">๐ฆ ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ</h3>
                            <p style="margin: 0 0 15px 0; color: #666;">ุงุญุชูุธ ุจูุณุฎุฉ ูู ุฌููุน ุจูุงูุงุชู (ุงูููุชุฌุงุชุ ุงูุฒุจุงุฆูุ ุงูููุงุชูุฑุ ุฅูุฎ.)</p>
                            <button class="btn btn-primary" onclick="createBackupNow()" id="backupBtn">
                                <span id="backupBtnText">๐พ ูุณุฎ ุงุญุชูุงุทู ุงูุขู</span>
                            </button>
                        </div>

                        <!-- ุงุณุชุฑุฌุงุน ูุณุฎุฉ -->
                        <div style="background: #fef3c7; padding: 20px; border-radius: 8px; border: 2px solid #f59e0b;">
                            <h3 style="margin: 0 0 10px 0; color: #92400e;">๐ ุงุณุชุฑุฌุงุน ูุณุฎุฉ ุงุญุชูุงุทูุฉ</h3>
                            <p style="margin: 0 0 15px 0; color: #666;">ุงุณุชุฑุฌุน ุจูุงูุงุชู ูู ููู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุณุงุจู</p>
                            <input type="file" id="restoreFile" accept=".json" style="margin-bottom: 10px;" onchange="handleRestoreFile(this)">
                            <button class="btn btn-warning" onclick="restoreBackupNow()" id="restoreBtn" disabled>
                                ๐ ุงุณุชุฑุฌุงุน ุงููุณุฎุฉ
                            </button>
                        </div>

                        <!-- ุณุฌู ุงููุณุฎ -->
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border: 2px solid #10b981;">
                            <h3 style="margin: 0 0 10px 0; color: #065f46;">๐ ุณุฌู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ</h3>
                            <div id="backupHistory" style="max-height: 200px; overflow-y: auto;">
                                <p class="text-muted">ูุง ุชูุฌุฏ ูุณุฎ ุงุญุชูุงุทูุฉ ุจุนุฏ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุณุฌู ุงูุนูููุงุช -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>๐ ุณุฌู ุงูุนูููุงุช</h2>
                    <button class="btn btn-secondary btn-sm" onclick="exportAuditLogs()">๐ฅ ุชุตุฏูุฑ</button>
                </div>
                <div class="card-body">
                    <!-- ุงูููุงุชุฑ -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">ููุน ุงูุนูููุฉ</label>
                            <select id="actionFilter" class="form-control" onchange="loadAuditLogs()">
                                <option value="">ุงููู</option>
                                <option value="create">ุฅูุดุงุก</option>
                                <option value="update">ุชุนุฏูู</option>
                                <option value="delete">ุญุฐู</option>
                                <option value="login">ุชุณุฌูู ุฏุฎูู</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">ุงูุฌุฏูู</label>
                            <select id="tableFilter" class="form-control" onchange="loadAuditLogs()">
                                <option value="">ุงููู</option>
                                <option value="products">ุงูููุชุฌุงุช</option>
                                <option value="customers">ุงูุฒุจุงุฆู</option>
                                <option value="suppliers">ุงูููุฑุฏูู</option>
                                <option value="invoices">ููุงุชูุฑ ุงููุจูุนุงุช</option>
                                <option value="supplies">ููุงุชูุฑ ุงูุดุฑุงุก</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">ุนุฏุฏ ุงูุณุฌูุงุช</label>
                            <select id="limitFilter" class="form-control" onchange="loadAuditLogs()">
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                                <option value="500">500</option>
                            </select>
                        </div>
                    </div>

                    <!-- ุฌุฏูู ุงูุณุฌูุงุช -->
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ุงูุชุงุฑูุฎ</th>
                                    <th>ุงูุนูููุฉ</th>
                                    <th>ุงูุฌุฏูู</th>
                                    <th>ุงููุตู</th>
                                </tr>
                            </thead>
                            <tbody id="auditLogsTable">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">ุฌุงุฑู ุงูุชุญููู...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ูุนูููุงุช ุงูุฃูุงู -->
            <div class="card" style="margin-top: 20px; background: #fef2f2; border: 2px solid #dc2626;">
                <div class="card-header" style="background: #dc2626; color: white;">
                    <h2 style="margin: 0;">๐ ูุนูููุงุช ุงูุฃูุงู</h2>
                </div>
                <div class="card-body">
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 5px;">
                            <span><strong>๐ก๏ธ ุญูุงูุฉ XSS:</strong></span>
                            <span style="color: #10b981; font-weight: 600;">โ ููุนููุฉ</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 5px;">
                            <span><strong>๐ซ Rate Limiting:</strong></span>
                            <span style="color: #10b981; font-weight: 600;">โ ููุนูู (5 ูุญุงููุงุช/15 ุฏูููุฉ)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 5px;">
                            <span><strong>๐ ุณุฌู ุงูุนูููุงุช:</strong></span>
                            <span style="color: #10b981; font-weight: 600;">โ ููุนูู</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 5px;">
                            <span><strong>๐พ ุงููุณุฎ ุงูุงุญุชูุงุทู:</strong></span>
                            <span style="color: #10b981; font-weight: 600;">โ ูุชุงุญ</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 5px; border-right: 4px solid #dc2626;">
                        <p style="margin: 0; color: #666; font-size: 14px;">
                            <strong>โ๏ธ ููุงุญุธุฉ ูุงูุฉ:</strong> ููุญูุงุธ ุนูู ุฃูุงู ุจูุงูุงุชู:
                        </p>
                        <ul style="margin: 10px 0 0 20px; color: #666; font-size: 14px;">
                            <li>ูู ุจุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุจุดูู ุฏูุฑู</li>
                            <li>ูุง ุชุดุงุฑู ุจูุงูุงุช ุชุณุฌูู ุงูุฏุฎูู ูุน ุฃุญุฏ</li>
                            <li>ุฑุงุฌุน ุณุฌู ุงูุนูููุงุช ุจุงูุชุธุงู</li>
                            <li>ุงุณุชุฎุฏู ูููุฉ ูุฑูุฑ ูููุฉ</li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/security.js"></script>
    <script src="js/rate-limiter.js"></script>
    <script src="js/backup-manager.js"></script>
    <script src="js/audit-logger.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/page-protection.js"></script>
    <script src="js/utils.js"></script>

    <script>
        let currentUser = null;
        let selectedBackup = null;

        protectPage().then(authorized => { if (authorized) loadPage(); });

        async function loadPage() {
            const { user, profile } = await getCurrentUserData();
            currentUser = user;
            document.getElementById('storeName').textContent = profile.store_name;

            await loadBackupHistory();
            await loadAuditLogs();

            hideLoading();
        }

        // ========== ุงููุณุฎ ุงูุงุญุชูุงุทู ==========

        async function createBackupNow() {
            const btn = document.getElementById('backupBtn');
            const btnText = document.getElementById('backupBtnText');

            try {
                btn.disabled = true;
                btnText.textContent = 'โณ ุฌุงุฑู ุฅูุดุงุก ุงููุณุฎุฉ...';

                const backup = await backupManager.createBackup(currentUser.id);
                backupManager.downloadBackup(backup);

                // ุชุณุฌูู ูู ุณุฌู ุงูุนูููุงุช
                await auditLogger.log('backup', 'system', null, null, { 
                    items: backup.data.products?.length + backup.data.customers?.length + backup.data.suppliers?.length 
                }, 'ูุณุฎ ุงุญุชูุงุทู ูุฏูู');

                alert('โ ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ!\n\nุชู ุชุญููู ุงูููู ุนูู ุฌูุงุฒู.');
                await loadBackupHistory();
                await loadAuditLogs();

            } catch (error) {
                console.error('ุฎุทุฃ ูู ุงููุณุฎ ุงูุงุญุชูุงุทู:', error);
                alert('โ ุญุฏุซ ุฎุทุฃ: ' + error.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = '๐พ ูุณุฎ ุงุญุชูุงุทู ุงูุขู';
            }
        }

        function handleRestoreFile(input) {
            const file = input.files[0];
            const btn = document.getElementById('restoreBtn');

            if (file) {
                backupManager.readBackupFile(file)
                    .then(backup => {
                        selectedBackup = backup;
                        btn.disabled = false;
                        btn.textContent = `๐ ุงุณุชุฑุฌุงุน (${backup.timestamp})`;
                    })
                    .catch(error => {
                        alert('โ ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู: ' + error.message);
                        selectedBackup = null;
                        btn.disabled = true;
                    });
            } else {
                selectedBackup = null;
                btn.disabled = true;
            }
        }

        async function restoreBackupNow() {
            if (!selectedBackup) {
                alert('โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ููู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฃููุงู');
                return;
            }

            try {
                const stats = await backupManager.restoreBackup(selectedBackup, currentUser.id, false);

                // ุชุณุฌูู ูู ุณุฌู ุงูุนูููุงุช
                await auditLogger.log('restore', 'system', null, null, stats, 'ุงุณุชุฑุฌุงุน ูุณุฎุฉ ุงุญุชูุงุทูุฉ');

                alert(`โ ุชู ุงูุงุณุชุฑุฌุงุน ุจูุฌุงุญ!\n\nุงูููุชุฌุงุช: ${stats.products}\nุงูุฒุจุงุฆู: ${stats.customers}\nุงูููุฑุฏูู: ${stats.suppliers}`);
                
                // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
                window.location.reload();

            } catch (error) {
                if (error.message !== 'ุฑูุฒ PIN ุบูุฑ ุตุญูุญ') {
                    console.error('ุฎุทุฃ ูู ุงูุงุณุชุฑุฌุงุน:', error);
                    alert('โ ุญุฏุซ ุฎุทุฃ: ' + error.message);
                }
            }
        }

        async function loadBackupHistory() {
            const container = document.getElementById('backupHistory');
            const history = backupManager.getHistory();

            if (history.length === 0) {
                container.innerHTML = '<p class="text-muted">ูุง ุชูุฌุฏ ูุณุฎ ุงุญุชูุงุทูุฉ ุจุนุฏ</p>';
                return;
            }

            container.innerHTML = history.map(item => {
                const date = new Date(item.timestamp);
                const total = Object.values(item.counts).reduce((sum, count) => sum + count, 0);

                return `
                    <div style="padding: 10px; background: white; border-radius: 5px; margin-bottom: 8px; border-right: 3px solid #10b981;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${date.toLocaleString('ar-IQ')}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 3px;">
                                    ${total} ุนูุตุฑ
                                    (${item.counts.products} ููุชุฌุ ${item.counts.customers} ุฒุจููุ ${item.counts.suppliers} ููุฑุฏ)
                                </div>
                            </div>
                            <span style="color: #10b981;">โ</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== ุณุฌู ุงูุนูููุงุช ==========

        async function loadAuditLogs() {
            const tbody = document.getElementById('auditLogsTable');

            try {
                const filters = {
                    action: document.getElementById('actionFilter').value,
                    tableName: document.getElementById('tableFilter').value,
                    limit: parseInt(document.getElementById('limitFilter').value)
                };

                const logs = await auditLogger.getLogs(filters);

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ูุง ุชูุฌุฏ ุณุฌูุงุช</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => {
                    const date = new Date(log.created_at || log.timestamp);
                    const actionLabel = auditLogger.getActionLabel(log.action);
                    const tableLabel = auditLogger.getTableLabel(log.table_name);

                    let actionColor = '#666';
                    if (log.action === 'create') actionColor = '#10b981';
                    else if (log.action === 'update') actionColor = '#3b82f6';
                    else if (log.action === 'delete') actionColor = '#dc2626';

                    return `
                        <tr>
                            <td style="font-size: 13px;">${date.toLocaleString('ar-IQ')}</td>
                            <td><span style="color: ${actionColor}; font-weight: 600;">${actionLabel}</span></td>
                            <td>${tableLabel}</td>
                            <td style="font-size: 13px;">${log.description || '-'}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุงูุณุฌูุงุช:', error);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">ุฎุทุฃ ูู ุงูุชุญููู</td></tr>';
            }
        }

        async function exportAuditLogs() {
            try {
                await auditLogger.exportLogs();
            } catch (error) {
                alert('โ ุญุฏุซ ุฎุทุฃ ูู ุงูุชุตุฏูุฑ');
            }
        }
    </script>
</body>
</html>
