<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูููุงุชูุฑ - ูุธุงู ุฅุฏุงุฑุฉ ุงููุญู</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <h1>๐ช <span id="storeName">ูุธุงู ุฅุฏุงุฑุฉ ุงููุญู</span></h1>
        <div class="header-actions">
            <button class="btn" onclick="App.logout()">
                ๐ช ุชุณุฌูู ุงูุฎุฑูุฌ
            </button>
        </div>
    </header>

    <div class="main-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <span class="icon">๐</span>
                        ููุญุฉ ุงูุชุญูู
                    </a>
                </li>
                <li class="nav-item">
                    <a href="new-invoice.html" class="nav-link">
                        <span class="icon">โ</span>
                        ูุงุชูุฑุฉ ุฌุฏูุฏุฉ
                    </a>
                </li>
                <li class="nav-item">
                    <a href="invoices.html" class="nav-link active">
                        <span class="icon">๐</span>
                        ุงูููุงุชูุฑ
                    </a>
                </li>
                <li class="nav-item">
                    <a href="products.html" class="nav-link">
                        <span class="icon">๐ฆ</span>
                        ุงูููุชุฌุงุช
                    </a>
                </li>
                <li class="nav-item">
                    <a href="customers.html" class="nav-link">
                        <span class="icon">๐ฅ</span>
                        ุงูุฒุจุงุฆู
                    </a>
                </li>
                <li class="nav-item">
                    <a href="supplies.html" class="nav-link">
                        <span class="icon">๐ฅ</span>
                        ุงูุชูุฑูุฏุงุช
                    </a>
                </li>
                <li class="nav-item">
                    <a href="statistics.html" class="nav-link">
                        <span class="icon">๐</span>
                        ุงูุฅุญุตุงุฆูุงุช
                    </a>
                </li>
                <li class="nav-item">
                    <a href="settings.html" class="nav-link">
                        <span class="icon">โ๏ธ</span>
                        ุงูุฅุนุฏุงุฏุงุช
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="card">
                <div class="card-header">
                    <h2>๐ ุงูููุงุชูุฑ ุงูุณุงุจูุฉ</h2>
                    <a href="new-invoice.html" class="btn btn-primary">
                        โ ูุงุชูุฑุฉ ุฌุฏูุฏุฉ
                    </a>
                </div>
                <div class="card-body">
                    <!-- Filters -->
                    <div class="filters-bar">
                        <div class="search-box">
                            <span class="search-icon">๐</span>
                            <input type="text" id="searchInvoice" placeholder="ุงูุจุญุซ ุจุฑูู ุงููุงุชูุฑุฉ..."
                                onkeyup="filterInvoices()">
                        </div>
                        <div class="form-group mb-0">
                            <input type="date" id="dateFrom" class="form-control" onchange="filterInvoices()">
                        </div>
                        <div class="form-group mb-0">
                            <input type="date" id="dateTo" class="form-control" onchange="filterInvoices()">
                        </div>
                        <div class="form-group mb-0">
                            <select id="statusFilter" class="form-control" onchange="filterInvoices()">
                                <option value="">ูู ุงูุญุงูุงุช</option>
                                <option value="active">ูุดุทุฉ</option>
                                <option value="cancelled">ููุบุงุฉ</option>
                            </select>
                        </div>
                    </div>

                    <!-- Invoices Table -->
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ุฑูู ุงููุงุชูุฑุฉ</th>
                                    <th>ุงูุชุงุฑูุฎ</th>
                                    <th>ุงูุฒุจูู</th>
                                    <th>ุนุฏุฏ ุงูููุชุฌุงุช</th>
                                    <th>ุงูุฅุฌูุงูู</th>
                                    <th>ุงูุญุงูุฉ</th>
                                    <th>ุงูุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTable">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        ูุง ุชูุฌุฏ ููุงุชูุฑ ุจุนุฏ
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary -->
                    <div class="invoice-summary mt-3" id="summary" style="display: none;">
                        <div class="row">
                            <span>ุฅุฌูุงูู ุงูููุงุชูุฑ:</span>
                            <span id="totalInvoices">0</span>
                        </div>
                        <div class="row">
                            <span>ุงูููุงุชูุฑ ุงููุดุทุฉ:</span>
                            <span id="activeInvoices">0</span>
                        </div>
                        <div class="row total-row">
                            <span>ุฅุฌูุงูู ุงููุจูุนุงุช (ุงููุดุทุฉ):</span>
                            <span id="totalSales">0 ุฏ.ุน</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/app.js"></script>
    <script>
        // ุญูุงูุฉ ุงูุตูุญุฉ
        if (!App.protectPage()) {
            throw new Error('Unauthorized');
        }

        // ุชุญููู ุงุณู ุงููุญู
        document.getElementById('storeName').textContent = App.getSettings().storeName;

        let allInvoices = [];

        // ุชุญููู ุงูููุงุชูุฑ
        function loadInvoices() {
            allInvoices = App.getInvoices().sort((a, b) =>
                new Date(b.date) - new Date(a.date)
            );
            filterInvoices();
        }

        // ููุชุฑุฉ ุงูููุงุชูุฑ
        function filterInvoices() {
            const search = document.getElementById('searchInvoice').value.toLowerCase();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const status = document.getElementById('statusFilter').value;

            let filtered = allInvoices.filter(inv => {
                // ุงูุจุญุซ ุจุฑูู ุงููุงุชูุฑุฉ
                if (search && !inv.invoiceNumber.toLowerCase().includes(search)) {
                    return false;
                }

                // ููุชุฑ ุงูุชุงุฑูุฎ
                const invDate = new Date(inv.date).toISOString().split('T')[0];
                if (dateFrom && invDate < dateFrom) return false;
                if (dateTo && invDate > dateTo) return false;

                // ููุชุฑ ุงูุญุงูุฉ
                if (status && inv.status !== status) return false;

                return true;
            });

            renderInvoices(filtered);
        }

        // ุนุฑุถ ุงูููุงุชูุฑ
        function renderInvoices(invoices) {
            const tbody = document.getElementById('invoicesTable');
            const summary = document.getElementById('summary');

            if (invoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            ูุง ุชูุฌุฏ ููุงุชูุฑ
                        </td>
                    </tr>
                `;
                summary.style.display = 'none';
                return;
            }

            summary.style.display = 'block';

            tbody.innerHTML = invoices.map(inv => `
                <tr>
                    <td>
                        <a href="print-invoice.html?id=${inv.id}">
                            <strong>${inv.invoiceNumber}</strong>
                        </a>
                    </td>
                    <td>${Utils.formatDateTime(inv.date)}</td>
                    <td>${inv.customerName || '-'}</td>
                    <td>${inv.items.length}</td>
                    <td>${Utils.formatCurrency(inv.total)}</td>
                    <td>
                        <span class="badge ${inv.status === 'active' ? 'badge-success' : 'badge-danger'}">
                            ${inv.status === 'active' ? 'ูุดุทุฉ' : 'ููุบุงุฉ'}
                        </span>
                    </td>
                    <td class="actions">
                        <a href="print-invoice.html?id=${inv.id}" class="btn btn-sm btn-secondary" title="ุทุจุงุนุฉ">
                            ๐จ๏ธ
                        </a>
                        ${inv.status === 'active' ? `
                            <button class="btn btn-sm btn-danger" onclick="cancelInvoice('${inv.id}')" title="ุฅูุบุงุก">
                                โ
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');

            // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
            const activeInvoices = invoices.filter(i => i.status === 'active');
            const totalSales = activeInvoices.reduce((sum, i) => sum + i.total, 0);

            document.getElementById('totalInvoices').textContent = invoices.length;
            document.getElementById('activeInvoices').textContent = activeInvoices.length;
            document.getElementById('totalSales').textContent = Utils.formatCurrency(totalSales);
        }

        // ุฅูุบุงุก ูุงุชูุฑุฉ
        async function cancelInvoice(id) {
            const invoice = App.getInvoiceById(id);
            const confirmed = await Utils.confirm(
                `ูู ุฃูุช ูุชุฃูุฏ ูู ุฅูุบุงุก ุงููุงุชูุฑุฉ "${invoice.invoiceNumber}"ุ\n` +
                `ุณูุชู ุฅุฑุฌุงุน ุงูููุชุฌุงุช ูููุฎุฒูู.`
            );

            if (confirmed) {
                App.cancelInvoice(id);
                Utils.showAlert('ุชู ุฅูุบุงุก ุงููุงุชูุฑุฉ ูุฅุฑุฌุงุน ุงููุฎุฒูู', 'success');
                loadInvoices();
            }
        }

        // ุชุญููู ุงูุตูุญุฉ
        loadInvoices();
    </script>
</body>

</html>