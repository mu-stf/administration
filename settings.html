<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุฅุนุฏุงุฏุงุช - ูุธุงู ุฅุฏุงุฑุฉ ุงููุญู</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <h1>๐ช <span id="storeName">ูุธุงู ุฅุฏุงุฑุฉ ุงููุญู</span></h1>
        <div class="header-actions">
            <button class="btn" onclick="App.logout()">
                ๐ช ุชุณุฌูู ุงูุฎุฑูุฌ
            </button>
        </div>
    </header>

    <div class="main-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <span class="icon">๐</span>
                        ููุญุฉ ุงูุชุญูู
                    </a>
                </li>
                <li class="nav-item">
                    <a href="new-invoice.html" class="nav-link">
                        <span class="icon">โ</span>
                        ูุงุชูุฑุฉ ุฌุฏูุฏุฉ
                    </a>
                </li>
                <li class="nav-item">
                    <a href="invoices.html" class="nav-link">
                        <span class="icon">๐</span>
                        ุงูููุงุชูุฑ
                    </a>
                </li>
                <li class="nav-item">
                    <a href="products.html" class="nav-link">
                        <span class="icon">๐ฆ</span>
                        ุงูููุชุฌุงุช
                    </a>
                </li>
                <li class="nav-item">
                    <a href="customers.html" class="nav-link">
                        <span class="icon">๐ฅ</span>
                        ุงูุฒุจุงุฆู
                    </a>
                </li>
                <li class="nav-item">
                    <a href="supplies.html" class="nav-link">
                        <span class="icon">๐ฅ</span>
                        ุงูุชูุฑูุฏุงุช
                    </a>
                </li>
                <li class="nav-item">
                    <a href="statistics.html" class="nav-link">
                        <span class="icon">๐</span>
                        ุงูุฅุญุตุงุฆูุงุช
                    </a>
                </li>
                <li class="nav-item">
                    <a href="settings.html" class="nav-link active">
                        <span class="icon">โ๏ธ</span>
                        ุงูุฅุนุฏุงุฏุงุช
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="card">
                <div class="card-header">
                    <h2>โ๏ธ ุฅุนุฏุงุฏุงุช ุงููุญู</h2>
                </div>
                <div class="card-body">
                    <form id="settingsForm" style="max-width: 600px;">
                        <div class="form-group">
                            <label for="storeNameInput">ุงุณู ุงููุญู</label>
                            <input type="text" id="storeNameInput" class="form-control" placeholder="ุฃุฏุฎู ุงุณู ุงููุญู">
                        </div>

                        <div class="form-group">
                            <label for="phone">ุฑูู ุงููุงุชู</label>
                            <input type="tel" id="phone" class="form-control" placeholder="07XXXXXXXXX">
                        </div>

                        <div class="form-group">
                            <label for="address">ุงูุนููุงู</label>
                            <input type="text" id="address" class="form-control" placeholder="ุนููุงู ุงููุญู">
                        </div>

                        <div class="form-group">
                            <label for="agentName">ุงุณู ุงูููุฏูุจ</label>
                            <input type="text" id="agentName" class="form-control" placeholder="ุงุณู ุงูููุฏูุจ ุฃู ุงูุจุงุฆุน">
                        </div>

                        <div class="form-group">
                            <label for="invoicePrefix">ุจุงุฏุฆุฉ ุฑูู ุงููุงุชูุฑุฉ</label>
                            <input type="text" id="invoicePrefix" class="form-control" placeholder="ูุซุงู: INV">
                            <small class="text-muted">ุณูุธูุฑ ุฑูู ุงููุงุชูุฑุฉ ุจูุฐุง ุงูุดูู: INV-00001</small>
                        </div>

                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">
                                ๐พ ุญูุธ ุงูุฅุนุฏุงุฏุงุช
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Change Password Section -->
            <div class="card mt-3">
                <div class="card-header">
                    <h2>๐ ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</h2>
                </div>
                <div class="card-body">
                    <form id="passwordForm" style="max-width: 600px;">
                        <div class="form-group">
                            <label for="currentPassword">ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ</label>
                            <input type="password" id="currentPassword" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="newPassword">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
                            <input type="password" id="newPassword" class="form-control" required minlength="4">
                        </div>

                        <div class="form-group">
                            <label for="confirmNewPassword">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
                            <input type="password" id="confirmNewPassword" class="form-control" required minlength="4">
                        </div>

                        <div class="mt-3">
                            <button type="submit" class="btn btn-warning">
                                ๐ ุชุบููุฑ ูููุฉ ุงููุฑูุฑ
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Data Management -->
            <div class="card mt-3">
                <div class="card-header">
                    <h2>๐พ ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช</h2>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        โ๏ธ ุชุญุฐูุฑ: ุงูุจูุงูุงุช ูุฎุฒูุฉ ูู ุงููุชุตูุญ ููุท. ุนูุฏ ูุณุญ ุจูุงูุงุช ุงููุชุตูุญ ุณุชูููุฏ ุฌููุน ุงูุจูุงูุงุช.
                    </div>

                    <div class="d-flex gap-2" style="flex-wrap: wrap; margin-top: 16px;">
                        <button class="btn btn-secondary" onclick="exportData()">
                            ๐ค ุชุตุฏูุฑ ุงูุจูุงูุงุช
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                            ๐ฅ ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;"
                            onchange="importData(event)">
                        <button class="btn btn-danger" onclick="clearAllData()">
                            ๐๏ธ ูุณุญ ุฌููุน ุงูุจูุงูุงุช
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/app.js"></script>
    <script>
        // ุญูุงูุฉ ุงูุตูุญุฉ
        if (!App.protectPage()) {
            throw new Error('Unauthorized');
        }

        // ุชุญููู ุงูุฅุนุฏุงุฏุงุช
        function loadSettings() {
            const settings = App.getSettings();

            document.getElementById('storeName').textContent = settings.storeName;
            document.getElementById('storeNameInput').value = settings.storeName;
            document.getElementById('phone').value = settings.phone || '';
            document.getElementById('address').value = settings.address || '';
            document.getElementById('agentName').value = settings.agentName || '';
            document.getElementById('invoicePrefix').value = settings.invoicePrefix || 'INV';
        }

        // ุญูุธ ุงูุฅุนุฏุงุฏุงุช
        document.getElementById('settingsForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const settings = {
                storeName: document.getElementById('storeNameInput').value.trim() || 'ุงููุญู',
                phone: document.getElementById('phone').value.trim(),
                address: document.getElementById('address').value.trim(),
                agentName: document.getElementById('agentName').value.trim(),
                invoicePrefix: document.getElementById('invoicePrefix').value.trim() || 'INV'
            };

            App.saveSettings(settings);
            document.getElementById('storeName').textContent = settings.storeName;
            Utils.showAlert('ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ', 'success');
        });

        // ุชุบููุฑ ูููุฉ ุงููุฑูุฑ
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            // ุงูุชุญูู ูู ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ
            const isValid = await App.verifyPassword(currentPassword);
            if (!isValid) {
                Utils.showAlert('ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ ุบูุฑ ุตุญูุญุฉ', 'danger');
                return;
            }

            // ุงูุชุญูู ูู ุชุทุงุจู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ
            if (newPassword !== confirmNewPassword) {
                Utils.showAlert('ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ุบูุฑ ูุชุทุงุจูุฉ', 'danger');
                return;
            }

            // ุงูุชุญูู ูู ุทูู ูููุฉ ุงููุฑูุฑ
            if (newPassword.length < 4) {
                Utils.showAlert('ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู 4 ุฃุญุฑู ุนูู ุงูุฃูู', 'danger');
                return;
            }

            // ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ
            await App.setupPassword(newPassword);
            Utils.showAlert('ุชู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ', 'success');

            // ูุณุญ ุงููููุฐุฌ
            document.getElementById('passwordForm').reset();
        });

        // ุชุตุฏูุฑ ุงูุจูุงูุงุช
        function exportData() {
            const data = {
                settings: App.getSettings(),
                products: App.getProducts(),
                customers: App.getCustomers(),
                invoices: App.getInvoices(),
                supplies: App.getSupplies(),
                invoiceNumber: localStorage.getItem(App.KEYS.INVOICE_NUMBER),
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `store-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            Utils.showAlert('ุชู ุชุตุฏูุฑ ุงูุจูุงูุงุช ุจูุฌุงุญ', 'success');
        }

        // ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const confirmed = await Utils.confirm('ุณูุชู ุงุณุชุจุฏุงู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ. ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ');
            if (!confirmed) {
                event.target.value = '';
                return;
            }

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                // ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช
                if (data.settings) App.saveSettings(data.settings);
                if (data.products) App.saveProducts(data.products);
                if (data.customers) App.saveCustomers(data.customers);
                if (data.invoices) App.saveInvoices(data.invoices);
                if (data.supplies) App.saveSupplies(data.supplies);
                if (data.invoiceNumber) localStorage.setItem(App.KEYS.INVOICE_NUMBER, data.invoiceNumber);

                Utils.showAlert('ุชู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุจูุฌุงุญ', 'success');
                loadSettings();
            } catch (error) {
                Utils.showAlert('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู', 'danger');
            }

            event.target.value = '';
        }

        // ูุณุญ ุฌููุน ุงูุจูุงูุงุช
        async function clearAllData() {
            const confirmed = await Utils.confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ุฌููุน ุงูุจูุงูุงุชุ ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู!');
            if (!confirmed) return;

            const doubleConfirm = await Utils.confirm('ุชุฃููุฏ ููุงุฆู: ุณูุชู ูุณุญ ุฌููุน ุงูููุชุฌุงุช ูุงูููุงุชูุฑ ูุงูุฒุจุงุฆู. ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ');
            if (!doubleConfirm) return;

            // ูุณุญ ุฌููุน ุงูุจูุงูุงุช ูุง ุนุฏุง ูููุฉ ุงููุฑูุฑ ูุงูุฌูุณุฉ
            localStorage.removeItem(App.KEYS.SETTINGS);
            localStorage.removeItem(App.KEYS.PRODUCTS);
            localStorage.removeItem(App.KEYS.CUSTOMERS);
            localStorage.removeItem(App.KEYS.INVOICES);
            localStorage.removeItem(App.KEYS.SUPPLIES);
            localStorage.removeItem(App.KEYS.INVOICE_NUMBER);

            // ุฅุนุงุฏุฉ ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ
            App.saveSettings({
                storeName: 'ุงููุญู',
                phone: '',
                address: '',
                agentName: '',
                invoicePrefix: 'INV'
            });
            localStorage.setItem(App.KEYS.INVOICE_NUMBER, '1');

            Utils.showAlert('ุชู ูุณุญ ุฌููุน ุงูุจูุงูุงุช', 'success');
            loadSettings();
        }

        // ุชุญููู ุงูุตูุญุฉ
        loadSettings();
    </script>
</body>

</html>