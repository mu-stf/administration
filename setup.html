<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุนุฏุงุฏ ูุนูููุงุช ุงููุญู - ูุธุงู ุฅุฏุงุฑุฉ ุงููุญู</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="auth-container">
        <div class="auth-box">
            <div class="icon">๐ช</div>
            <h1>ูุฑุญุจุงู ุจู!</h1>
            <p>ูู ุจุฅุนุฏุงุฏ ูุนูููุงุช ูุญูู ููุจุฏุก</p>

            <form id="setupForm">
                <div class="form-group">
                    <label for="storeName">ุงุณู ุงููุญู *</label>
                    <input type="text" id="storeName" class="form-control" placeholder="ุงุณู ูุญูู" required>
                </div>

                <div class="form-group">
                    <label for="phone">ุฑูู ุงููุงุชู</label>
                    <input type="tel" id="phone" class="form-control" placeholder="07XXXXXXXXX">
                </div>

                <div class="form-group">
                    <label for="address">ุงูุนููุงู</label>
                    <input type="text" id="address" class="form-control" placeholder="ุนููุงู ุงููุญู">
                </div>

                <div class="form-group">
                    <label for="agentName">ุงุณู ุงููููู</label>
                    <input type="text" id="agentName" class="form-control" placeholder="ุงุณู ุตุงุญุจ ุฃู ูููู ุงููุญู">
                </div>

                <div class="form-group">
                    <label for="invoicePrefix">ุจุงุฏุฆุฉ ุงููุงุชูุฑุฉ *</label>
                    <input type="text" id="invoicePrefix" class="form-control" placeholder="INV" value="INV" required
                        maxlength="10">
                    <small class="text-muted">ุณุชุธูุฑ ูุจู ุฑูู ุงููุงุชูุฑุฉ (ูุซุงู: INV-00001)</small>
                </div>

                <div id="errorMessage" class="alert alert-danger hidden"></div>

                <button type="submit" class="btn btn-primary btn-block" id="setupBtn">
                    ุญูุธ ูุงููุชุงุจุนุฉ
                </button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/utils.js"></script>
    <script>
        let currentUser = null;
        const setupFlag = sessionStorage.getItem('in_setup');

        // ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
        async function checkAuth() {
            // ููุน infinite loop
            if (setupFlag) {
                sessionStorage.removeItem('in_setup');
                return;
            }

            sessionStorage.setItem('in_setup', 'true');

            try {
                const session = await SupabaseDB.getSession();
                if (!session) {
                    sessionStorage.removeItem('in_setup');
                    window.location.href = 'index.html';
                    return;
                }

                currentUser = await SupabaseDB.getCurrentUser();

                // ุงูุชุญูู ูู ูุฌูุฏ profile
                try {
                    const profile = await SupabaseDB.getProfile(currentUser.id);
                    if (profile && profile.store_name !== 'ุงููุญู') {
                        // ุงููุณุชุฎุฏู ุฃููู ุงูุฅุนุฏุงุฏ ูุณุจูุงู
                        sessionStorage.removeItem('in_setup');
                        sessionStorage.setItem('setup_complete', 'true');
                        window.location.href = 'dashboard.html';
                    }
                } catch (error) {
                    console.log('ูู ูุชู ุฅุนุฏุงุฏ ุงูููู ุงูุดุฎุตู ุจุนุฏ');
                }

                sessionStorage.removeItem('in_setup');
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุงูุชุญูู:', error);
                sessionStorage.removeItem('in_setup');
                window.location.href = 'index.html';
            }
        }

        checkAuth();

        document.getElementById('setupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const storeName = document.getElementById('storeName').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            const agentName = document.getElementById('agentName').value;
            const invoicePrefix = document.getElementById('invoicePrefix').value;
            const errorDiv = document.getElementById('errorMessage');
            const setupBtn = document.getElementById('setupBtn');

            // ุฅุฎูุงุก ุฑุณุงูุฉ ุงูุฎุทุฃ
            errorDiv.classList.add('hidden');

            try {
                setupBtn.disabled = true;
                setupBtn.textContent = 'ุฌุงุฑู ุงูุญูุธ...';

                // ุชุญุฏูุซ ูุนูููุงุช ุงููุญู
                await SupabaseDB.updateProfile(currentUser.id, {
                    store_name: storeName,
                    phone: phone || null,
                    address: address || null,
                    agent_name: agentName || null,
                    invoice_prefix: invoicePrefix || 'INV'
                });

                // ุงูุชุญููู ูุตูุญุฉ ููุญุฉ ุงูุชุญูู
                Utils.showAlert('ุชู ุญูุธ ูุนูููุงุช ุงููุญู ุจูุฌุงุญ!', 'success');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);

            } catch (error) {
                console.error('ุฎุทุฃ ูู ุงูุญูุธ:', error);
                errorDiv.textContent = 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุจูุงูุงุช: ' + error.message;
                errorDiv.classList.remove('hidden');

                setupBtn.disabled = false;
                setupBtn.textContent = 'ุญูุธ ูุงููุชุงุจุนุฉ';
            }
        });
    </script>
</body>

</html>