<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>????? ??????? ????? - ???? ????? ?????</title>
    <link rel="stylesheet" href="css/style-responsive.css">
</head>

<body>
    <div class="auth-container">
        <div class="auth-box">
            <div class="icon">??</div>
            <h1>?????? ??!</h1>
            <p>?? ?????? ??????? ???? ?????</p>

            <form id="setupForm">
                <div class="form-group">
                    <label for="storeName">??? ????? *</label>
                    <input type="text" id="storeName" class="form-control" placeholder="??? ????" required>
                </div>

                <div class="form-group">
                    <label for="phone">??? ??????</label>
                    <input type="tel" id="phone" class="form-control" placeholder="07XXXXXXXXX">
                </div>

                <div class="form-group">
                    <label for="address">???????</label>
                    <input type="text" id="address" class="form-control" placeholder="????? ?????">
                </div>

                <div class="form-group">
                    <label for="agentName">??? ??????</label>
                    <input type="text" id="agentName" class="form-control" placeholder="??? ???? ?? ???? ?????">
                </div>

                <div class="form-group">
                    <label for="invoicePrefix">????? ???????? *</label>
                    <input type="text" id="invoicePrefix" class="form-control" placeholder="INV" value="INV" required
                        maxlength="10">
                    <small class="text-muted">????? ??? ??? ???????? (????: INV-00001)</small>
                </div>

                <div id="errorMessage" class="alert alert-danger hidden"></div>

                <button type="submit" class="btn btn-primary btn-block" id="setupBtn">
                    ??? ?????????
                </button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/utils.js"></script>
    <script>
        let currentUser = null;
        const setupFlag = sessionStorage.getItem('in_setup');

        // ?????? ?? ????? ??????
        async function checkAuth() {
            // ??? infinite loop
            if (setupFlag) {
                sessionStorage.removeItem('in_setup');
                return;
            }

            sessionStorage.setItem('in_setup', 'true');

            try {
                const session = await SupabaseDB.getSession();
                if (!session) {
                    sessionStorage.removeItem('in_setup');
                    window.location.href = 'index.html';
                    return;
                }

                currentUser = await SupabaseDB.getCurrentUser();

                // ?????? ?? ???? profile
                try {
                    const profile = await SupabaseDB.getProfile(currentUser.id);
                    if (profile && profile.store_name !== '?????') {
                        // ???????? ???? ??????? ??????
                        sessionStorage.removeItem('in_setup');
                        sessionStorage.setItem('setup_complete', 'true');
                        window.location.href = 'dashboard.html';
                    }
                } catch (error) {
                    console.log('?? ??? ????? ????? ?????? ???');
                }

                sessionStorage.removeItem('in_setup');
            } catch (error) {
                console.error('??? ?? ??????:', error);
                sessionStorage.removeItem('in_setup');
                window.location.href = 'index.html';
            }
        }

        checkAuth();

        document.getElementById('setupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const storeName = document.getElementById('storeName').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            const agentName = document.getElementById('agentName').value;
            const invoicePrefix = document.getElementById('invoicePrefix').value;
            const errorDiv = document.getElementById('errorMessage');
            const setupBtn = document.getElementById('setupBtn');

            // ????? ????? ?????
            errorDiv.classList.add('hidden');

            try {
                setupBtn.disabled = true;
                setupBtn.textContent = '???? ?????...';

                // ????? ??????? ?????
                await SupabaseDB.updateProfile(currentUser.id, {
                    store_name: storeName,
                    phone: phone || null,
                    address: address || null,
                    agent_name: agentName || null,
                    invoice_prefix: invoicePrefix || 'INV'
                });

                // ??????? ????? ???? ??????
                Utils.showAlert('?? ??? ??????? ????? ?????!', 'success');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);

            } catch (error) {
                console.error('??? ?? ?????:', error);
                errorDiv.textContent = '??? ??? ????? ??? ????????: ' + error.message;
                errorDiv.classList.remove('hidden');

                setupBtn.disabled = false;
                setupBtn.textContent = '??? ?????????';
            }
        });
    </script>
</body>

</html>